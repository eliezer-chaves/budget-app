<div class="container mt-4 p-3 shadow bg-white rounded">
  <h4 *ngIf="user(); else loading">Bem-vindo {{user()?.full_name | firstName}}</h4>
  <ng-template #loading>
    <p>Carregando dados do usuário...</p>
  </ng-template>

  <button nz-button nzType="primary" class="mt-4" (click)="showModal()">Nova Compra</button>
</div>
<div class="container mt-4 shadow bg-white rounded p-3">
  <h5 class="card-title">Dados das últimas compras</h5>
  <div class="container mt-4 d-flex justify-content-around cards">
    
    <!-- Card 1: Total Gasto -->
    <ng-container *ngIf="!loadingCards; else loadingTemplate">
      <div class="card shadow p-3 d-flex align-items-center justify-content-center card-resumo">
        <b class="text-center card-label">Total Gasto</b>
        <span class="text-center card-value mt-1" *ngIf="totalGasto > 0; else templateSemCompra">
          {{ totalGasto | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
        </span>
      </div>
    </ng-container>

    <!-- Card 2: Compras Realizadas -->
    <ng-container *ngIf="!loadingCards; else loadingTemplate">
      <div class="card shadow p-3 d-flex align-items-center justify-content-center card-resumo">
        <b class="text-center card-label ">Compras Realizadas</b>
        <span class="text-center card-value mt-1" *ngIf="comprasRealizadas > 0; else templateSemCompra">
          {{ comprasRealizadas }}
        </span>
      </div>
    </ng-container>

    <!-- Card 3: Compras em Aberto -->
    <ng-container *ngIf="!loadingCards; else loadingTemplate">
      <div class="card shadow p-3 d-flex align-items-center justify-content-center card-resumo">
        <b class="text-center card-label">Compras em Aberto</b>
        <span class="text-center card-value mt-1" *ngIf="comprasEmAberto > 0; else templateSemCompraEmAberto">
          {{ comprasEmAberto }}
        </span>
      </div>
    </ng-container>

    <!-- Templates Reutilizáveis -->
    <ng-template #loadingTemplate>
      <div class="card shadow p-3 d-flex align-items-center justify-content-center card-resumo">
        <nz-spin [nzSize]="'small'"></nz-spin>
      </div>
    </ng-template>

    <ng-template #templateSemCompra>
      <span class="text-center card-value">Nenhuma Compra</span>
    </ng-template>

    <ng-template #templateSemCompraEmAberto>
      <span class="text-center card-value">Nenhuma em Aberto</span>
    </ng-template>
  </div>
</div>

<div class="container mt-4 bg-white p-3 shadow rounded">
  <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" style="max-width: 300px;">
    <input type="text" nz-input placeholder="Informe algum item..." [(ngModel)]="termoPesquisa"
      (keyup.enter)="pesquisarItem()" />
  </nz-input-group>

  <ng-template #suffixIconButton>
    <button nz-button nzType="primary" nzSize="default" nzSearch (click)="pesquisarItem()"
      [nzLoading]="loadingSearchButton">
      Pesquisar
    </button>
  </ng-template>

  <div class="mt-4 ">
    <nz-spin [nzSpinning]="loadingTable">
      <nz-table #borderedTable nzBordered [nzData]="searchItems" [nzShowPagination]="false" class="">
        <thead>
          <tr>
            <th class="text-center">Data</th>
            <th class="text-center">Nome</th>
            <th class="text-center">Preço</th>
            <th class="text-center">Lugar</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of searchItems" class="text-center">
            <td class="text-center">{{ item.date | date: 'dd/MM/yyyy' }}</td>
            <td class="text-center">{{ item.name }}</td>
            <td class="text-center">
              {{ item.price | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
            </td>
            <td class="text-center">{{ item.place }}</td>
          </tr>
        </tbody>
      </nz-table>
    </nz-spin>
  </div>
</div>

<!--Modal-->
<nz-modal [(nzVisible)]="isVisible" [nzTitle]="modalTitle" [nzContent]="modalContent" [nzFooter]="modalFooter"
  (nzOnCancel)="handleCancel()">
  <ng-template #modalTitle>Nova Compra</ng-template>

  <ng-template #modalContent>

    <nz-input-group nzAddOnBefore="Data da Compra" class="w-100">
      <nz-date-picker [(ngModel)]="dataCompra" class="w-100" (ngModelChange)="onChange($event)"
        nzFormat="dd/MM/yyyy"></nz-date-picker>
    </nz-input-group>

    <nz-form-control [nzErrorTip]="'O nome do mercado é obrigatório'">
      <nz-input-group nzAddOnBefore="Local" class="mt-2 ">
        <input type="text" nz-input placeholder="Ex: Supermercado" [(ngModel)]="mercadoNome" name="mercadoNome" required
          #mercadoInput="ngModel" />
      </nz-input-group>
    </nz-form-control>

    <nz-input-group nzAddOnBefore="Quantidade de Categorias" class="mt-2">
      <nz-input-number [(ngModel)]="qtdCarrinhos" nzMin="1" class="w-100" (ngModelChange)="onQtdCarrinhosChange($event)"
        value=1 />
    </nz-input-group>

    <div *ngFor="let name of carrinhosNames; let i = index; trackBy: trackByFn">
      <nz-input-group [nzAddOnBefore]="'Categoria'" class="mt-2">
        <input #inputEl type="text" nz-input placeholder="Ex: Alimentação" [(ngModel)]="carrinhosNames[i]"
          (keydown)="onKeyDown($event, i)" />
      </nz-input-group>
    </div>
  </ng-template>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="handleCancel()">Cancelar</button>
    <button nz-button nzType="primary" (click)="handleOk()" [nzLoading]="isConfirmLoading">Avançar</button>
  </ng-template>
</nz-modal>